<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Data Preparation Tools</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Data Preparation Tools</h1>



<p>Built 2022-02-05 using NMdata 0.0.11.</p>
<p>This vignette is still under development. Please make sure to see latest version available <a href="https://philipdelff.github.io/NMdata/">here</a>.</p>
<div id="objectives" class="section level2">
<h2>Objectives</h2>
<p>This vignettes aims at enabling you at</p>
<ul>
<li><p>Using NMdata’s data preparation tools to assist building your data set</p></li>
<li><p>Using <code>mergeCheck</code> to automatically check merge results, ensuring rows do not get lost or duplicated</p></li>
<li><p>Assigning exclusion flags and obtain a table summary counting data exclusions from source data to analysis data set</p></li>
<li><p>Easily and consistently order data columns using <code>NMorderColumns</code></p></li>
<li><p>Using <code>NMcheckData</code> to perform a extensive data check before exporting for Nonmem</p></li>
<li><p>Writing the prepared data to file ensuring compatibility with NONMEM and for post-processing in R using <code>NMwriteData</code></p></li>
<li><p>Updating multiple NONMEM control streams to read the updated data file using one simple call of the <code>NMwriteSection</code> function</p></li>
</ul>
<p>Only basic R knowledge should be required to follow the instructions.</p>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Getting data ready for modeling is a crucial and often underestimated task. Mistakes during the process of combining data sets, defining time variables etc. can lead to difficulties during modeling, need for revisiting data set preparation, and in worst case wasted time working with an erroneos data set. Avoiding those mistakes by integrating checks into the data preparation process is a key element in an efficient and reliable data preparation work flow.</p>
<p>Furthermore, NONMEM has a number of restrictions on the format of the input data, and problems with the data set is a common reason for NONMEM not to behave as expected. When this happens, debugging can be time-consuming. <code>NMdata</code> includes some simple functions to prevent these situations.</p>
<p>This vignette uses <code>data.table</code> syntax for the little bit of data manipulation performed. However, you don’t need to use data.table <em>at all</em> to use these or any tool in <code>NMdata</code>. The data set is a <code>data.table</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;examples/data/xgxr2.rds&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;NMdata&quot;</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">class</span>(pk)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;data.table&quot; &quot;data.frame&quot;</span></span></code></pre></div>
<p>If you are not familiar with <code>data.table</code>, you can still keep reading this vignette and learn what <code>NMdata</code> can do. <code>data.table</code> is a powerful enhancement to the <code>data.frame</code> class, and the syntax is a little different from <code>data.frame</code>. The few places where this affects the examples provided here, explanations will be given. You can replace all use of <code>data.table</code> in this vignette with base R functions, tidyverse functions or whatever you prefer.</p>
</div>
<div id="data-assembly" class="section level2">
<h2>Data assembly</h2>
<div id="compare-presence-and-class-of-columns-across-data-sets" class="section level3">
<h3>Compare presence and class of columns across data sets</h3>
<p>When stacking (<code>rbind</code>) and merging, it is most often necessary to check if two or more data sets are compatible for the operation. <code>compareCols</code> compares columns across two or more data sets.</p>
<p>To illustrate the output of <code>compareCols</code>, a slightly modified version of the <code>pk</code> dataset has been created. One column (<code>CYCLE</code>) has been removed, and <code>AMT</code> has been recoded to character. <code>compareCols</code> tells us about exactly these two differences:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">compareCols</span>(pk, pk.reduced)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co">#&gt; Dimensions:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="co">#&gt;          data nrows ncols</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co">#&gt; 1:         pk  1502    24</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="co">#&gt; 2: pk.reduced   751    23</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">#&gt; Columns that differ:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="co">#&gt;    column      pk pk.reduced</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="co">#&gt; 1:  CYCLE integer       &lt;NA&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="co">#&gt; 2:    AMT integer  character</span></span></code></pre></div>
<p>Before merging or stacking, we may want to recode <code>AMT</code> in one of the datasets to get the class we need, and decide what to do about the <code>CYCLE</code> column which is missing in one of the datasets (add information or fill with <code>NA</code>?).</p>
<p>When stacking data sets we often know what columns we are looking to obtain in the final data. We may already have defined that early in our data preparation script, and <code>compareCols</code> can use this to highlight these columns. <code>cc</code> is a shorthand function to create character vectors withour quoting the elements.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>special.columns &lt;-<span class="st"> </span><span class="kw">cc</span>(ID, TIME, CYCLE, STUDY, BW)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">compareCols</span>(pk, pk.reduced, <span class="dt">cols.wanted =</span> special.columns)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="co">#&gt; Dimensions:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="co">#&gt;          data nrows ncols</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="co">#&gt; 1:         pk  1502    24</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="co">#&gt; 2: pk.reduced   751    23</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="co">#&gt; Columns that differ:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="co">#&gt;    column      pk pk.reduced</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a><span class="co">#&gt; 1:    *ID integer    integer</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="co">#&gt; 2:  *TIME numeric    numeric</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a><span class="co">#&gt; 3: *CYCLE integer       &lt;NA&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a><span class="co">#&gt; 4: *STUDY integer    integer</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a><span class="co">#&gt; 5:    *BW    &lt;NA&gt;       &lt;NA&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="co">#&gt; 6:    AMT integer  character</span></span></code></pre></div>
<p>In this case, we may want to add <code>diff.only=FALSE</code> to see if other columns could hold the information we are missing for <code>BW</code> and <code>CYCLE</code>.</p>
</div>
<div id="rename-columns-based-on-contents" class="section level3">
<h3>Rename columns based on contents</h3>
<p>The model estimation step is heavily dependent (and in NONMEM almost entirely based) on numeric data values. The source data will often contain character variables, i.e. columns with non-numeric data values.</p>
<p>If the column names reflect whether the values are numeric, double-checking can be avoided. <code>renameByContents</code> renames columns if a function of their contents returns <code>TRUE</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>pk.renamed &lt;-<span class="st"> </span><span class="kw">renameByContents</span>(<span class="dt">data =</span> pktmp, <span class="dt">fun.test =</span> NMisNumeric,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="dt">fun.rename =</span> tolower, <span class="dt">invert.test =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>We make use of the function <code>NMisNumeric</code> which tests if NONMEM can interpret the contents as numeric. If say the subject ID is of character class, it can be valid to NONMEM. Subject ID <code>&quot;1039&quot;</code> will be a numeric in NONMEM, <code>&quot;1-039&quot;</code> will not. <code>NMisNumeric</code> will return <code>TRUE</code> if and only if all elements are either missing or interpretable as numeric. We invert the condition (<code>invert.test=TRUE</code>), and <em>the names</em> of the columns that NONMEM cannot interpret as numeric become lowercase. We use <code>compareCols</code> to illustrate that three columns were renamed:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">compareCols</span>(pktmp, pk.renamed)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="co">#&gt; Dimensions:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="co">#&gt;          data nrows ncols</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="co">#&gt; 1:      pktmp  1502    23</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="co">#&gt; 2: pk.renamed  1502    23</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co">#&gt; Columns that differ:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="co">#&gt;      column     pktmp pk.renamed</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="co">#&gt; 1:   EVENTU character       &lt;NA&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="co">#&gt; 2:     NAME character       &lt;NA&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a><span class="co">#&gt; 3: TIMEUNIT character       &lt;NA&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a><span class="co">#&gt; 4:   eventu      &lt;NA&gt;  character</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a><span class="co">#&gt; 5:     name      &lt;NA&gt;  character</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a><span class="co">#&gt; 6: timeunit      &lt;NA&gt;  character</span></span></code></pre></div>
<p>We can now easily see that if we wish to include the information contained in <code>eventu</code>, <code>pktmp</code>, and <code>pk.renamed</code>, we have to modify or translate their contents first.</p>
</div>
<div id="automated-checks-of-merge-results" class="section level3">
<h3>Automated checks of merge results</h3>
<p>Merge or join operations are a very powerful data preparion tool. But they are also a very common source of bugs. Most of us know too well how merges can leave us with unexpected rows or make rows disappear. However, most often we can impose restrictions on the merge operation that allows for automated validation of the results.</p>
<p>Imagine the very common example that we have a longitudinal PK data set (called <code>pk</code>), and we want to add subject-level covariates from a secondary data set (<code>dt.cov</code>). We want to merge by <code>ID</code>, and all we can allow to happen is columns to be added to <code>pk</code> from <code>dt.cov</code>. If rows disappear or get repeated, or if columns get renamed, it’s unintended and should return an error. That is what <code>mergeCheck</code> is for.</p>
<p>Often people check the dimensions of the result to make sure nothing unintended happened. The following example shows that this is not enough, and that <code>mergeCheck</code> works differently. After merging the two data sets the check of the dimensions raises no alarm - the number of rows is unchanged from <code>pk</code> to <code>pk2</code>, and one of two columns in <code>dt.cov</code> was added. <code>dims</code> is just a <code>dim</code>-like function that can compare multiple data sets - handy for interactive analysis.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>pk2 &lt;-<span class="st"> </span><span class="kw">merge</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="kw">dims</span>(pk, dt.cov, pk2)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co">#&gt;      data nrows ncols</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co">#&gt; 1:     pk  1502    24</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">#&gt; 2: dt.cov   150     2</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="co">#&gt; 3:    pk2  1502    25</span></span></code></pre></div>
<p>What we didn’t realize is that we now have twice as many rows for subject 31.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>pk[ID <span class="op">==</span><span class="st"> </span><span class="dv">31</span>, .N]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>pk2[ID <span class="op">==</span><span class="st"> </span><span class="dv">31</span>, .N]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">#&gt; [1] 20</span></span></code></pre></div>
<p>If we instead use <code>mergeCheck</code>, we get an error. This is because <code>mergeCheck</code> compares the actual rows going in and out of the merge and not just the dimensions.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">mergeCheck</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co">#&gt; Rows disappeared during merge.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="co">#&gt; Rows duplicated during merge.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="co">#&gt; Overview of dimensions of input and output data:</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="co">#&gt;      data nrows ncols</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co">#&gt; 1:     pk  1502    25</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a><span class="co">#&gt; 2: dt.cov   150     2</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a><span class="co">#&gt; 3: result  1502    26</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="co">#&gt; Overview of values of by where number of rows in x changes:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a><span class="co">#&gt;     ID N.x N.result</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a><span class="co">#&gt; 1:  31  10       20</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="co">#&gt; 2: 180  10        0</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a><span class="co">#&gt; Error in mergeCheck(pk, dt.cov, by = &quot;ID&quot;): Merge added and/or removed rows.</span></span></code></pre></div>
<p>Notice that <code>mergeCheck</code> tells us for which values of <code>ID</code> (the <code>by</code> argument which can be of length &gt;1) the input and output differ so we can quickly look into the data sets and make a decision how we want to handle this. In this case we discard the covariate value for subject 31 and use <code>all.x=TRUE</code> argument to get <code>NA</code> for subjects 31 and 180:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>dt.cov2 &lt;-<span class="st"> </span>dt.cov[ID <span class="op">!=</span><span class="st"> </span><span class="dv">31</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>pk2.check &lt;-<span class="st"> </span><span class="kw">mergeCheck</span>(pk, dt.cov2, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="co">#&gt; The following columns were added: COV</span></span></code></pre></div>
<p>To ensure the consistency of rows before and after the merge, you could use <code>merge(...,all.x=TRUE)</code> and then check dimensions before and after (yes, both <code>all.x=TRUE</code> and the dimension check are necessary). This is not needed if you use <code>mergeCheck</code>.</p>
<p><code>mergeCheck</code> does not try to reimplement merging. Under the hood, the merge is performed by <code>data.table::merge.data.table</code> to which most arguments are passed. What <code>mergeCheck</code> does is to add the checks that the results are consistent with the criteria outlined above. <code>data.table::merge.data.table</code> is generally very fast, and even if there is a bit of extra calculations in <code>mergeCheck</code>, it should never be slow.</p>
<p>In summary, <code>mergeCheck</code> verifies that the rows that result from the merge are the exact same as in one of the existing datasets, only columns added from the second input dataset. You may think that this will limit your merges, and that you need merges for inner and outer joins etc. You are exactly right - <code>mergeCheck</code> is not intended for those merges and does not support them. When that is said, the kind of merges that are supported by <code>mergeCheck</code> are indeed very common. All merges in the <code>NMdata</code> package are performed with <code>mergeCheck</code>.</p>
<div id="additional-mergecheck-features" class="section level4">
<h4>Additional <code>mergeCheck</code> features</h4>
<p>Another problem the programmer may not realize during a merge is when column names are shared across <code>x1</code> and <code>x2</code> (in addition to columns that are being merged by). This will silently create column names like <code>col.x</code> and <code>col.y</code> in the output. <code>mergeCheck</code> will by default give a warning if that happens (can be modified using the <code>fun.commoncols</code> argument). Also, there is an optional argument to tell mergeCheck how many columns are expected to be added by the merge, and <code>mergeCheck</code> will fail if another number of columns are added. This can be useful for programming.</p>
<p>The row order of the first data set is by default maintained by <code>mergeCheck</code>. Apart from this, there is only one difference from the behavior of the <code>merge.data.frame</code> function syntax, being that either the <code>by</code> argument or <code>by.x</code> and <code>by.y</code> must always be supplied to <code>mergeCheck</code>. Default behavior of <code>merge.data.frame</code> is to merge by all common column names, but for coding transparency, this is intentionally not allowed by <code>mergeCheck</code>.</p>
</div>
</div>
</div>
<div id="exclusion-flags" class="section level2">
<h2>Exclusion flags</h2>
<p>There is no way around excluding some of the events in data due to various reasons. And we need to be able to answer to why we excluded each of the points, and to how many points were excluded due to which criteria. <code>NMdata</code> provides two functions to handle this - <code>flagsAssign</code> assigns exclusion flags to data records (rows), and <code>flagsCount</code> summarizes the number of discarded rows and the reasons.</p>
<p>This implementation makes it easy to keep the rows flagged for exclusion in the dataset and ignore them in NONMEM. Or if you prefer, you can remove the rows after generating an overview of the exclusion counts for your report.</p>
<p><code>flagsAssign</code> and <code>flagsCount</code> are based on sequential evaulation of exclusion criteria. This means we can summarize how many records and subjects were excluded from the analysis due to the different criteria. The information is represented in one numerical column for NONMEM, and one (value-to-value corresponding) character column for the rest of us in the resulting data.</p>
<div id="assign-and-count-flags" class="section level3">
<h3>Assign and count flags</h3>
<p>For use in NONMEM’s <code>IGNORE</code> feature, the easiest is that inclusion/exclusion is determined by a single column in data - we call that column <code>FLAG</code> here, but any column name can be used. <code>FLAG</code> obviously draws on information from other columns such as <code>TIME</code>, <code>DV</code>, and many others, depending on your dataset and your way of working.</p>
<p>The function that applies inclusion/excluasion rules is called <code>flagsAssign</code>, and it takes a dataset and a data.frame with rules as arguments. In this simple example we only exclude data due to two different reasons - and only samples (keeping all doses in the analysis). We exclude all pre-dose samples. For post-dose samples, we exclude those below LLOQ.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>dt.flags &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="dt">text =</span> <span class="st">&quot;FLAG,flag,condition</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="st">10,Below LLOQ,BLQ==1</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="st">100,Negative time,TIME&lt;0&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">flagsAssign</span>(pk, <span class="dt">tab.flags =</span> dt.flags, <span class="dt">subset.data =</span> <span class="st">&quot;EVID==0&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="co">#&gt; Coding FLAG = 100, flag = Negative time</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="co">#&gt; Coding FLAG = 10, flag = Below LLOQ</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">flagsAssign</span>(pk, <span class="dt">subset.data =</span> <span class="st">&quot;EVID==1&quot;</span>, <span class="dt">flagc.0 =</span> <span class="st">&quot;Dose&quot;</span>)</span></code></pre></div>
<p><code>fread</code> is used to create a data.table (like <code>read.csv</code> to create a data.frame) for readability, one line for each row in the data.table created. <code>flagsAssign</code> applies the conditions sequentially and by decreasing value of <code>FLAG</code>. <code>FLAG=0</code> means that the observation is included in the analysis. You can use any expression that can be evaluated within the data.frame. In this case, <code>BLQ</code> has to exist in <code>pk</code>.</p>
<p>Finally, flags are assigned to <code>EVID==1</code> rows. Here, no flag table is used. This means that all <code>EVID==1</code> rows will get <code>FLAG=0</code> and <code>flag=&quot;Dose&quot;</code>. You can use a separate data.frame of flags for dosing records as needed.</p>
<p>In NONMEM, you can include <code>IGNORE=(FLAG.NE.0)</code> in <code>$DATA</code> or <code>$INFILE</code>.</p>
<p>Again, the omission will be attributed to the first condition matched. Default is to apply the conditions by the order of decreasing numerical flag value. Use <code>flags.increasing=TRUE</code> if you prefer the opposite. However, what cannot be modified is that 0 is the numerical value for rows that are not matched by any conditions.</p>
<p>What rows to omit from a data set can vary from one analysis to another. Hence, the aim with the chosen design is that the inclusion criteria can be changed and applied to overwrite an existing inclusion/exclusion selection. For another analysis we want to include the observations below LLOQ. We have two options. Either we simply change the <code>IGNORE</code> statement given above to <code>IGNORE=(FLAG.LT.10)</code>, or you create a different exclusion flag for that one. If you prefer to create a new set of exclusion flags, just use new names for the numerical and the character flag columns so you don’t overwrite the old ones. See help of <code>flagsAssign</code> and <code>flagsCount</code> for how.</p>
</div>
<div id="summarize-data-exclusions" class="section level3">
<h3>Summarize data exclusions</h3>
<p>An overview of the number of observations disregarded due to the different conditions is then obtained using <code>flagsCount</code>. As we see from the <code>names</code> call below, both discarded, cumulative discarded, and observations left after application of the respective criterion are available. Choose the ones you prefer - here we show how many observations and subjects were matched by eached criterion and how many were left after application of each criterion.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>tab.count &lt;-<span class="st"> </span><span class="kw">flagsCount</span>(<span class="dt">data =</span> pk[EVID <span class="op">==</span><span class="st"> </span><span class="dv">0</span>], <span class="dt">tab.flags =</span> dt.flags)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="kw">names</span>(tab.count)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;flag&quot;          &quot;N.left&quot;        &quot;Nobs.left&quot;     &quot;N.discard&quot;    </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="co">#&gt; [5] &quot;N.disc.cum&quot;    &quot;Nobs.discard&quot;  &quot;Nobs.disc.cum&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>tab.count[, .(flag, N.discard, Nobs.discard, N.left, Nobs.left)]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="co">#&gt;                  flag N.discard Nobs.discard N.left Nobs.left</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="co">#&gt; 1: All available data        NA           NA    150      1352</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="co">#&gt; 2:      Negative time         0            2    150      1350</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="co">#&gt; 3:         Below LLOQ        19          595    131       755</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="co">#&gt; 4:       Analysis set        NA           NA    131       755</span></span></code></pre></div>
<p><code>flagsCount</code> includes a <code>file</code> argument to save the the table right away.</p>
</div>
</div>
<div id="finalize-data-format-and-write-to-file" class="section level2">
<h2>Finalize data format and write to file</h2>
<p>Once the dataset is in place, <code>NMdata</code> provides a few useful functions to ensure the formatting of the written data is compatible with NONMEM. These functions include checks that NONMEM will be able to interpret the data as intended, and more features are under development in this area.</p>
<div id="automated-ordering-of-columns" class="section level3">
<h3>Automated ordering of columns</h3>
<p>The order of columns in NONMEM is important for two reasons. One is that a character in a variable read into NONMEM will make the run fail. The other is that there are restrictions on the number of variables you can read into NONMEM, depending on the version. <code>NMorderColumns</code> tries to put the used columns first, and other or maybe even unusable columns in the back of the dataset. It does so by a mix of recognition of column names and analysis of the column contents.</p>
<p>Columns that cannot be converted to numeric are put in the back, while column bearing standard NONMEM variable names like <code>ID</code>, <code>TIME</code>, <code>EVID</code> etc. will be pulled up front. You can of course add column names to prioritize to front (<code>first</code>) or back (<code>last</code>). See <code>?NMorderColumns</code> for more options.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">NMorderColumns</span>(pk)</span></code></pre></div>
<p>One trick is worth mentioning here. If you are adding variables to a data set after having started to model with NONMEM, you may not want to have to update and rerun your NONMEM models right away. <code>NMorderColumns</code> has options for putting some variable last (to the right) in data. That argument is called <code>last</code>. It has several other options to tweak how the columns are ordered so you can hopefully get the order you want.</p>
</div>
</div>
<div id="checking-the-data-set" class="section level2">
<h2>Checking the data set</h2>
<p>Before we save the data and go to model estimation, <code>NMdata</code> offers a quite extensive and automated function to check data for consistency and compatibility with NONMEM.</p>
<p><code>NMcheckData</code> checks all the standard NONMEM columns against the NONMEM requirements and looks for other common data issues. The list is quite long. Please see <code>?NMcheckData</code> for a list of performed checks.</p>
<p>We can add subject level covariates, and subject-occasion covariates to be checked for whether they are non-missing, numeric and not varying with subject or subject-occasion. We can also add other numeric variables to use in NONMEM to check for missing values.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>findings &lt;-<span class="st"> </span><span class="kw">NMcheckData</span>(pk, <span class="dt">covs =</span> <span class="kw">c</span>(<span class="st">&quot;DOSE&quot;</span>, <span class="st">&quot;WEIGHTB&quot;</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="co">#&gt;   column                     check  N Nid</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="co">#&gt;     EVID        Subject has no obs 19  19</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="co">#&gt;      MDV          Column not found  1   0</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="co">#&gt;  WEIGHTB  Cov not unique within ID  1   1</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a><span class="co">#&gt;      AMT Non-positive dose amounts  1   1</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="co">#&gt;     EVID           EVID not in 0:4  1   1</span></span></code></pre></div>
<p>Let’s look at these findings:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>findings</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="co">#&gt;     row  ID  column                     check  level  ROW</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="co">#&gt; 1    NA  31    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="co">#&gt; 2    NA  32    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="co">#&gt; 3    NA  33    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a><span class="co">#&gt; 4    NA  34    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="co">#&gt; 5    NA  36    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="co">#&gt; 6    NA  37    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="co">#&gt; 7    NA  38    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a><span class="co">#&gt; 8    NA  39    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a><span class="co">#&gt; 9    NA  42    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a><span class="co">#&gt; 10   NA  44    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a><span class="co">#&gt; 11   NA  45    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a><span class="co">#&gt; 12   NA  46    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a><span class="co">#&gt; 13   NA  49    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a><span class="co">#&gt; 14   NA  52    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a><span class="co">#&gt; 15   NA  53    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a><span class="co">#&gt; 16   NA  56    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a><span class="co">#&gt; 17   NA  57    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a><span class="co">#&gt; 18   NA  58    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a><span class="co">#&gt; 19   NA  60    EVID        Subject has no obs     ID   NA</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a><span class="co">#&gt; 20   NA  NA     MDV          Column not found column   NA</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a><span class="co">#&gt; 21   NA 180 WEIGHTB  Cov not unique within ID     ID   NA</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true"></a><span class="co">#&gt; 22 1403 171     AMT Non-positive dose amounts    row 1403</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true"></a><span class="co">#&gt; 23 1480 178    EVID           EVID not in 0:4    row 1480</span></span></code></pre></div>
<p>Depending on <code>level</code> we can now take a look at single rows, data from a subject or fix a column to address these. The fact that some subjects are missing observations in this case is not necessarily an error (they are in this case all BLQ), but <code>WEIGHTB</code> has to be constant within subjects, and for NONMEM to even run, <code>EVID</code> must be in <code>0:4</code>. So those have to be fixed. For the rest of the vighnette, assume we fixed those issues.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">copy</span>(pk.copy)</span></code></pre></div>
<div id="writing-data-to-files" class="section level3">
<h3>Writing data to files</h3>
<p>For the final step of writing the dataset, <code>NMwriteData</code> is provided. Most importantly, it writes a csv file with appropriate options for NONMEM to read it as well as possible. It can also write an rds for R with equal contents (or RData if you prefer), but with the rds including all information (such as factor levels) which cannot be saved in csv. If you should use <code>NMscanData</code> to read NONMEM results, this information can be used automatically. <code>NMwriteData</code> also by default calls <code>NMgenText</code> which provides a proposal for text to include in the <code>$INPUT</code> and <code>$DATA</code> sections of the NONMEM control streams. There are several arguments that will affect the proposed text for the NONMEM run, see <code>?NMwriteData</code> and especially <code>?NMgenText</code>.</p>
<p>Let’s include the origin script of the data as meta data. <code>write.csv=TRUE</code> is default but included here because we often want to use something like <code>write.csv=writeOutput</code> where <code>writeOutput</code> is a switching variable we set to <code>TRUE</code> or <code>FALSE</code> in the initialization section of the script.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>text.nm &lt;-<span class="st"> </span><span class="kw">NMwriteData</span>(pk, <span class="dt">file =</span> <span class="st">&quot;derived/pkdata.csv&quot;</span>, <span class="dt">script =</span> <span class="st">&quot;DataPrepare.Rmd&quot;</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    <span class="dt">write.csv =</span> <span class="ot">TRUE</span>, <span class="dt">args.stamp =</span> <span class="kw">list</span>(<span class="dt">Description =</span> <span class="st">&quot;PK data for the Data Preparation vignette.&quot;</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="co">#&gt; Data written to file(s):</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="co">#&gt; derived/pkdata.csv</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="co">#&gt; derived/pkdata.rds</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="co">#&gt; For NONMEM:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a><span class="co">#&gt; $INPUT ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a><span class="co">#&gt; PART PROFDAY PROFTIME WEIGHTB eff0</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a><span class="co">#&gt; $DATA derived/pkdata.csv</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a><span class="co">#&gt; IGN=@</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a><span class="co">#&gt; IGNORE=(FLAG.NE.0)</span></span></code></pre></div>
<p>We are being told that two files were saved, and then we get some text to use in the NONMEM control streams. <code>NMwriteData</code> detected the exclusion flag and suggests to include it in <code>$DATA</code>.</p>
<p>Let’s take a look at what was saved:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="kw">list.files</span>(<span class="st">&quot;derived&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;pkdata.csv&quot;      &quot;pkdata.rds&quot;      &quot;pkdata_meta.txt&quot;</span></span></code></pre></div>
<p>There is a metadata file which <code>NMreadCsv</code> will automatically recognize if found. The metadata becomes accessible using <code>NMinfo</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>dat.inp &lt;-<span class="st"> </span><span class="kw">NMreadCsv</span>(<span class="st">&quot;derived/pkdata.csv&quot;</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="kw">NMinfo</span>(dat.inp)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="co">#&gt; $dataCreate</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;DataPrepare.Rmd&quot;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2022-02-05 12:58:16&quot;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$writtenTo</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;derived/pkdata.csv&quot;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$Description</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;PK data for the Data Preparation vignette.&quot;</span></span></code></pre></div>
<p>With the flexibility of the <code>rds</code> format, we don’t need such an additional file. Only difference on the metadata for the rds file is the filename:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>dat.inp.rds &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;derived/pkdata.rds&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="kw">NMinfo</span>(dat.inp.rds)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a><span class="co">#&gt; $dataCreate</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;DataPrepare.Rmd&quot;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2022-02-05 12:58:16 EST&quot;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$writtenTo</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;derived/pkdata.rds&quot;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$Description</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;PK data for the Data Preparation vignette.&quot;</span></span></code></pre></div>
</div>
<div id="updating-nonmem-control-streams-to-read-new-data-file" class="section level3">
<h3>Updating NONMEM control streams to read new data file</h3>
<p>If we have to update the input data file, the NONMEM <code>$INPUT</code> sections no longer match the input data. We saw in <code>NMorderColumns</code> how we can use the <code>last</code> argument to get columns pushed towards the back so the NONMEM runs should still work. But maybe you need the column in your nonmem runs, and so you have no way around updating the control streams. And that can be quite a lot of control streams. With <code>NMdata</code> that is really easy.</p>
<p><code>NMdata</code> has a couple of functions to extract and write sections to NONMEM control streams called <code>NMreadSection</code> and <code>NMwriteSection</code>. Those functions are very flexible for updating NONMEM control streams, and we will not tgo into detail with them, but let’s stick to the example above. We can do</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">NMwriteSection</span>(<span class="dt">dir =</span> <span class="st">&quot;nonmem&quot;</span>, <span class="dt">file.pattern =</span> <span class="st">&quot;run1.*</span><span class="ch">\\</span><span class="st">.mod&quot;</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>    <span class="dt">list.sections =</span> text.nm[<span class="st">&quot;INPUT&quot;</span>])</span></code></pre></div>
<p>This updates the INPUT section (and not DATA) for all control streams in directory “nonmem” which file names start with “run1” and end in “.mod” (say “run101.mod” to “run199.mod”). If we had done simply <code>list.sections=text.nm</code> instead of <code>list.sections=text.nm[&quot;INPUT&quot;]</code>, it would have replaced the <code>$DATA</code> section too. However, the <code>DATA</code> section rarely needs update following an pdate of the input data file, and oftentimes <code>$DATA</code> can vary among control streams that use the same input data (some models may be estimated on a smaller subset of data), so be careful with that.</p>
<p><code>NMwriteSection</code> has the argument <code>data.file</code> to further limit the scope of files to update based on what data file the control streams use. It only makes sense to use the auto-generated text for control streams that use this data set.</p>
<p>The text for NONMEM can be generated without saving data using <code>NMgenText</code>. You can tailor the generation of the text to copy <code>(DV=CONC)</code>, drop <code>(COL=DROP)</code>, rename (<code>DV</code> instead of <code>CONC</code>) and more.</p>
</div>
</div>
<div id="stamp-objects-for-traceability" class="section level2">
<h2>Stamp objects for traceability</h2>
<p>We saw how <code>NMwriteDatat</code> saves metadata automatically. Even if <code>NMwriteData</code> can actually be used as a simple rds writer that adds meta data the same way, we may want to save data or any R object using <code>saveRDS</code>. In that case, use <code>NMstamp</code> (which is also what <code>NMwriteData</code> does).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">NMstamp</span>(pk, <span class="dt">script =</span> <span class="st">&quot;vignettes/DataCreate.Rmd&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="kw">NMinfo</span>(pk)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="co">#&gt; $dataCreate</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;vignettes/DataCreate.Rmd&quot;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2022-02-05 12:58:16 EST&quot;</span></span></code></pre></div>
<p>The <code>script</code> argument is recognized by <code>NMstamp</code>, but you can add anything to this. We want to keep descriptive note too. Another often useful piece of information is what source data files were read in order to generate the saved data. <code>Description</code> and <code>Source.Files</code> are only examples - any name can be used.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">NMstamp</span>(pk, <span class="dt">script =</span> <span class="st">&quot;vignettes/DataCreate.Rmd&quot;</span>, <span class="dt">Description =</span> <span class="st">&quot;A PK dataset used for examples.&quot;</span>,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>    <span class="dt">Source.Files =</span> <span class="st">&quot;/path/to/adpc.sas7bdat,/path/to/adsl.sas7bdat&quot;</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a><span class="kw">NMinfo</span>(pk)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a><span class="co">#&gt; $dataCreate</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$DataCreateScript</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;vignettes/DataCreate.Rmd&quot;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$CreationTime</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2022-02-05 12:58:16 EST&quot;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$Description</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;A PK dataset used for examples.&quot;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true"></a><span class="co">#&gt; $dataCreate$Source.Files</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;/path/to/adpc.sas7bdat,/path/to/adsl.sas7bdat&quot;</span></span></code></pre></div>
<p>These are very simple functions. But hopefully they will help you avoid sitting with a data set trying to guess which script generated it.</p>
<p>Again, when using <code>NMwriteData</code>, you don’t have to call <code>NMstamp</code> explicitly. Just pass the <code>script</code> argument to <code>NMwriteData</code> and <code>NMstamp</code> will be applied automatically.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
